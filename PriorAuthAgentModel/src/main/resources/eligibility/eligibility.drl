//created on: Jul 16, 2021
package model

//list any import classes here.
import model.EligibilityAgent;
import data.MedicalInfo;
import data.Patient;
import policies.Policy;
import data.Physician;

import jade.lang.acl.ACLMessage;
import jade.core.AID;

//declare any global variables here





rule "Initial message"
	when
		$a : ACLMessage( $send : sender.name, $r : AllReceiver.next(), $c : content, ConversationId.equals("initial-info") )
		$e : EligibilityAgent( name.equals(((AID)$r).getName()) )
	then
		$e.parseForm($c);
		retract($a);		
end

rule "Missing name"
	when
		$p : Patient( firstName.equals("") || lastName.equals("") )
	then
		System.out.println("Missing name");
end

rule "Check name"
	when 
		$p : Patient( $f : firstName, $l : lastName )
		$i : MedicalInfo( $m : medication, $d : diagnosis )
	then
		System.out.println("Patient: " + $l + ", " +$f);
end

rule "Check treatment"
	when 
		$i : MedicalInfo( $m : medication, $d : diagnosis )
	then
		System.out.println("Treatment: " + $m + " for " +$d);
end

rule "In Network" salience 1
	when
		$p : Physician( $n : npiNumber )
		$pc : Policy( $npis : net_npis, net_npis contains $n )
	then
		System.out.println("Provider is in network");
		$p.setInNetwork(true);
end

rule "Out of Network" salience 1
	when
		$p : Physician( $n : npiNumber )
		$pc : Policy( $npis : net_npis, !(net_npis contains $n) )
	then
		System.out.println("Provider is out of network");
		$p.setInNetwork(false);
end

/*rule "Covered"
	when
		$i : MedicalInfo( $m : medication, $d : diagnosis, $e : explanation) and
		$elig : EligibilityAgent() and
		$pat : Patient() and
		(( $p : Physician( inNetwork == true ) and $pc : Policy( net_not_covered excludes $e ) )
			or
		( $p : Physician( inNetwork == false ) and $pc : Policy( oon_covered contains $e ) ))
	then
		System.out.println("Policy allows eligibility for treatment");
		$elig.quickMessage( $elig.getManager(), $elig, "true", "eligibility-approval");
		
		retract($i);
		retract($p);
		retract($pc);
		retract($pat);
end*/

rule "Covered"
	when
		$i : MedicalInfo( $m : medication, $d : diagnosis, $e : explanation)
		$p : Physician( $n : inNetwork )
		$pc : Policy( $oc : oon_covered, $nnc : net_not_covered)
		$elig : EligibilityAgent()
		$pat : Patient()
	then
		if ($n) {
			boolean bool = true;
			for (String covered : $nnc) {
				if ($e.equals(covered)) {
					bool = false;
				}
			}
			if (bool) {
				System.out.println("Policy does not allow eligibility for treatment");
				$elig.quickMessage( $elig.getManager(), $elig, "false", "eligibility-denial");
				
			} else {
				System.out.println("Policy allows eligibility for treatment");
				$elig.quickMessage( $elig.getManager(), $elig, "true", "eligibility-approval");
			}
		} else {
			boolean bool = false;
			for (String covered : $oc) {
				if ($e.equals(covered)) {
					bool = true;
				}
			}
			if (bool) {
				System.out.println("Policy allows eligibility for treatment");
				$elig.quickMessage( $elig.getManager(), $elig, "true", "eligibility-approval");
			} else {
				System.out.println("Policy does not allow eligibility for treatment");
				$elig.quickMessage( $elig.getManager(), $elig, "false", "eligibility-denial");
			}
		}
		
		retract($i);
		retract($p);
		retract($pc);
		retract($pat);
end
